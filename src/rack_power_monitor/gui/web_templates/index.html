<!DOCTYPE html>
<html>
<head>
    <title>Rack Power Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Handle refresh timer
        let refreshTimer;
        
        // Function to set the refresh rate
        function setRefreshRate(seconds) {
            // Clear any existing timer
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }
            
            // Convert to number
            const rate = parseInt(seconds);
            
            // If rate is valid and not zero, set new timer
            if (rate > 0) {
                refreshTimer = setTimeout(function() {
                    // Check which tab is currently active
                    const activeTab = localStorage.getItem("activeTab");
                    
                    // Only refresh if we're not on the Saved Data tab
                    if (activeTab !== "SavedDataTab") {
                        location.reload();
                    } else {
                        // If on Saved Data tab, just restart the timer without refreshing
                        setRefreshRate(rate);
                    }
                }, rate * 1000);
                
                // Save setting to localStorage
                localStorage.setItem("refreshRate", rate);
                
                // Optionally show feedback
                showRefreshToast(`Page will refresh every ${rate} seconds`);
            } else {
                // Auto-refresh disabled
                localStorage.setItem("refreshRate", "0");
                showRefreshToast('Auto-refresh turned off');
            }
        }
        
        // Simple toast notification
        function showRefreshToast(message) {
            // Create toast element if it doesn't exist
            let toast = document.getElementById('refresh-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'refresh-toast';
                document.body.appendChild(toast);
            }
            
            // Set message and show toast
            toast.textContent = message;
            toast.className = 'toast-visible';
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.className = '';
            }, 3000);
        }
        
        // Function to switch between tabs
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            
            // Hide all tab content
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Remove active class from all tab buttons
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Show the current tab and add active class to the button
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Store the active tab in localStorage
            localStorage.setItem("activeTab", tabName);
        }
        
        // When the page loads
        window.onload = function() {
            // Activate the saved tab or default to active
            const activeTab = localStorage.getItem("activeTab") || "ActiveTab";
            document.getElementById(activeTab).style.display = "block";
            document.querySelector('.tablinks[data-tab="' + activeTab + '"]').classList.add("active");
            
            // Set refresh rate based on saved preference
            const savedRate = localStorage.getItem("refreshRate");
            if (savedRate !== null) {
                // Update dropdown to match saved preference
                document.getElementById("refresh-rate").value = savedRate;
                // Initialize refresh timer
                setRefreshRate(savedRate);
            } else {
                // Default to 30 seconds if no preference saved
                setRefreshRate(30);
            }
        }
    </script>
</head>
<body>
    <div class="page-wrapper">
        <header>
            <h1>Rack Power Monitor Dashboard</h1>
        </header>
        
        <div class="content-wrapper">
            <div class="tab-container">
                <div class="tab">
                    <button class="tablinks" data-tab="ActiveTab" onclick="openTab(event, 'ActiveTab')">
                        Active ({{ active_count }})
                    </button>
                    <button class="tablinks" data-tab="StandbyTab" onclick="openTab(event, 'StandbyTab')">
                        Standby ({{ standby_count }})
                    </button>
                    <button class="tablinks" data-tab="SavedDataTab" onclick="openTab(event, 'SavedDataTab')">
                        Saved Data
                    </button>
                    <button class="tablinks" data-tab="ManageTab" onclick="openTab(event, 'ManageTab')">
                        Manage R-SCMs
                    </button>
                    
                    <!-- Refresh control remains unchanged -->
                    <div class="refresh-control">
                        <label for="refresh-rate">Auto-refresh:</label>
                        <select id="refresh-rate" onchange="setRefreshRate(this.value)">
                            <option value="0">Off</option>
                            <option value="10">10 seconds</option>
                            <option value="30" selected>30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="300">5 minutes</option>
                        </select>
                        <button id="manual-refresh" onclick="location.reload()" title="Refresh now">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <main>
                <!-- For Active Tab rack cards -->
                <div id="ActiveTab" class="tabcontent">
                    <div class="rack-container">
                        {% if active_racks %}
                            {% for rack in active_racks %}
                            <!-- Active rack card with enhanced statistics -->
                            <div class="rack-card">
                                <div class="rack-header">
                                    <h2>{{ rack.name }}</h2>
                                    <span class="status monitoring">{{ rack.status }}</span>
                                </div>
                                <div class="rack-details">
                                    <p class="address">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 2a6 6 0 0 0-6 6h12a6 6 0 0 0-6-6z"/>
                                        </svg>
                                        {{ rack.address }}
                                    </p>
                                    {% if rack.stats %}
                                    <div class="rack-stats">
                                        <p class="current-power">Current: <strong>{{ rack.stats.current }}</strong></p>
                                        {% if rack.stats.avg %}
                                        <p class="avg-power">Average: <strong>{{ rack.stats.avg }}</strong></p>
                                        {% endif %}
                                        <p class="readings">{{ rack.stats.count }} readings</p>
                                    </div>
                                    {% else %}
                                    <p class="no-data">No data available</p>
                                    {% endif %}
                                    
                                    <div class="rack-actions">
                                        <a href="/rack/{{ rack.name }}" class="view-button">View Details</a>
                                        <button class="action-btn stop" onclick="stopMonitoring('{{ rack.name }}')">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.5 5A1.5 1.5 0 0 0 5 6.5v3A1.5 1.5 0 0 0 6.5 11h3A1.5 1.5 0 0 0 11 9.5v-3A1.5 1.5 0 0 0 9.5 5h-3z"/>
                                            </svg>
                                            Stop Monitoring
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-racks">
                                <p>No racks are currently being monitored.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- For Standby Tab rack cards -->
                <div id="StandbyTab" class="tabcontent">
                    <div class="rack-container">
                        {% if standby_racks %}
                            {% for rack in standby_racks %}
                            <div class="rack-card">
                                <div class="rack-header">
                                    <h2>{{ rack.name }}</h2>
                                    <span class="status {{ rack.status.lower().replace(' ', '-') }}">{{ rack.status }}</span>
                                </div>
                                <div class="rack-details">
                                    <p class="address">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 2a6 6 0 0 0-6 6h12a6 6 0 0 0-6-6z"/>
                                        </svg>
                                        {{ rack.address }}
                                    </p>
                                    {% if rack.stats %}
                                    <div class="rack-stats">
                                        <p>Last Power: <strong>{{ rack.stats.current }}</strong></p>
                                        <p>Readings: {{ rack.stats.count }}</p>
                                        {% if rack.stats.mode %}
                                        <p>Most Common: {{ rack.stats.mode }}</p>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <p class="no-data">No data available</p>
                                    {% endif %}
                                    
                                    <div class="rack-actions">
                                        <a href="/rack/{{ rack.name }}" class="view-button">View Details</a>
                                        <button class="action-btn start" onclick="openStartMonitoringModal('{{ rack.name }}')">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
                                            </svg>
                                            Start Monitoring
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-racks">
                                <p>No standby racks found.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div id="monitoring-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal" onclick="closeMonitoringModal()">&times;</span>
                        <h3>Start Monitoring</h3>
                        <form id="start-monitoring-form">
                            <input type="hidden" id="rack-name-input" name="rack_name">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="interval-input">Interval (minutes):</label>
                                    <input type="number" id="interval-input" name="interval" min="0.1" step="0.1" value="1.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="duration-input">Duration (hours):</label>
                                    <input type="number" id="duration-input" name="duration" min="0" step="0.5" value="0" placeholder="0 for continuous">
                                    <small>Leave at 0 for continuous monitoring</small>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="primary-button">Start Monitoring</button>
                                <button type="button" class="secondary-button" onclick="closeMonitoringModal()">Cancel</button>
                            </div>
                        </form>
                        <div id="monitor-status" class="status-message"></div>
                    </div>
                </div>
                <!-- For Saved Data Tab (newly added) -->
                <div id="SavedDataTab" class="tabcontent">
                    <div class="saved-data-container">
                        <h2>Saved Monitoring Data</h2>
                        
                        <!-- Add RSCM filter dropdown -->
                        <div class="rscm-filter">
                            <label for="rscm-selector">Filter by RSCM:</label>
                            <select id="rscm-selector" onchange="filterRackSections(this.value)">
                                <option value="all">Show All RSCMs</option>
                                {% if saved_racks %}
                                    {% for rack in saved_racks %}
                                        <option value="{{ rack.name }}">{{ rack.name }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        
                        <!-- Data viewer panel -->
                        <div id="data-viewer" class="data-viewer">
                            <h3 id="viewer-title">Data Viewer</h3>
                            
                            <div class="stats-container">
                                <div class="stat-card">
                                    <div>Min Power</div>
                                    <div id="stat-min" class="stat-value">-</div>
                                </div>
                                <div class="stat-card">
                                    <div>Max Power</div>
                                    <div id="stat-max" class="stat-value">-</div>
                                </div>
                                <div class="stat-card">
                                    <div>Avg Power</div>
                                    <div id="stat-avg" class="stat-value">-</div>
                                </div>
                                <div class="stat-card">
                                    <div>Mode</div>
                                    <div id="stat-mode" class="stat-value">-</div>
                                </div>
                                <div class="stat-card">
                                    <div>Readings</div>
                                    <div id="stat-count" class="stat-value">-</div>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <canvas id="power-chart"></canvas>
                            </div>
                            
                            <div class="export-options">
                                <button id="export-csv" class="action-btn">Export CSV</button>
                                <button id="export-png" class="action-btn">Export Chart Image</button>
                                <button id="hide-viewer" class="action-btn" style="background-color:#666">Close Viewer</button>
                            </div>
                        </div>
                        
                        <!-- Pagination controls -->
                        <div class="pagination-controls">
                            <button id="prev-page" class="pagination-button" disabled>
                                &larr; Previous
                            </button>
                            <div class="pagination-info">
                                Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                            </div>
                            <button id="next-page" class="pagination-button">
                                Next &rarr;
                            </button>
                        </div>
                        
                        <!-- Container for paginated rack sections -->
                        <div id="rack-sections-container">
                            {% if saved_racks %}
                                {% for rack in saved_racks %}
                                    <div class="rack-section" data-page="1">
                                        <!-- Existing rack section content -->
                                        <h3>{{ rack.name }}</h3>
                                        
                                        {% if rack.csv_files %}
                                            <div class="files-grid">
                                                {% for file in rack.csv_files %}
                                                    <div class="file-card" onclick="loadFile('{{ file.name }}')">
                                                        <h4>{{ file.name }}</h4>
                                                        <div class="file-info">
                                                            <div>Size: {{ (file.size / 1024) | round(1) }} KB</div>
                                                            <div>Modified: {{ file.modified | timestamp }}</div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p>No CSV files found for this rack.</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="no-data">No saved data files found. Start monitoring racks to generate data.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- For Manage R-SCMs Tab (newly added) -->
                <div id="ManageTab" class="tabcontent">
                    <div class="manage-section">
        <h2>Manage R-SCMs</h2>
        
        <!-- Add new R-SCM form -->
        <div class="card">
            <h3>Add New R-SCM</h3>
            <form id="add-rscm-form" method="POST" action="/api/rscm/add">
    <div class="form-row">
        <div class="form-group">
            <label for="rack_name">Rack Name:</label>
            <input type="text" id="rack_name" name="rack_name" required placeholder="e.g., G24">
        </div>
        <div class="form-group">
            <label for="ip_address">IP Address:</label>
            <input type="text" id="ip_address" name="ip_address" required placeholder="e.g., 192.168.1.100">
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="primary-button">Add R-SCM</button>
        <button type="reset" class="secondary-button">Reset</button>
    </div>
</form>
            <div id="form-status" class="status-message"></div>
        </div>
        
        <!-- Existing R-SCMs List -->
        <div class="card mt-4">
            <h3>Configured R-SCMs</h3>
            <div class="rscm-list">
                <table>
                    <thead>
                        <tr>
                            <th>Rack Name</th>
                            <th>IP Address</th>
                            <th>Status</th>
                            <!-- Last Reading column removed -->
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rscm-table-body">
                        {% if all_racks %}
                            {% for rack in all_racks %}
                            <tr>
                                <td>{{ rack.name }}</td>
                                <td>{{ rack.address }}</td>
                                <td>
                                    <span class="status {{ rack.status.lower().replace(' ', '-') }}">
                                        {{ rack.status }}
                                    </span>
                                </td>
                                <!-- Last Reading column data removed -->
                                <td class="actions">
                                    <!-- Buttons remain unchanged -->
                                    <button onclick="editRSCM('{{ rack.name }}')" class="action-btn edit">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                        </svg>
                                        Edit
                                    </button>
                                    <button onclick="deleteRSCM('{{ rack.name }}')" class="action-btn delete">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="no-data">No R-SCMs configured yet</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
                
            </main>
        </div>
        
        <footer>
            <p>Rack Power Monitor v1.0</p>
        </footer>
    </div>
    
    <!-- Add this at the end of your HTML, before the closing body tag -->
    <script>
        // Handle form submission via AJAX
        document.getElementById('add-rscm-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const formStatus = document.getElementById('form-status');
            
            fetch('/api/rscm/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    formStatus.className = 'status-message success';
                    formStatus.textContent = 'R-SCM added successfully!';
                    this.reset();
                    
                    // Reload the page after a short delay to show the updated list
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    formStatus.className = 'status-message error';
                    formStatus.textContent = data.message || 'Failed to add R-SCM';
                }
            })
            .catch(error => {
                formStatus.className = 'status-message error';
                formStatus.textContent = 'An error occurred while submitting the form';
                console.error('Error:', error);
            });
        });
        
        // Toggle monitoring status
        function toggleMonitoring(rackName, start) {
            fetch(`/api/rscm/${start ? 'start' : 'pause'}/${rackName}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload to show updated status
                    location.reload();
                } else {
                    alert(data.message || `Failed to ${start ? 'start' : 'pause'} monitoring`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred');
            });
        }
        
        // Delete R-SCM
        function deleteRSCM(rackName) {
            if (confirm(`Are you sure you want to delete ${rackName}? This action cannot be undone.`)) {
                fetch(`/api/rscm/delete/${rackName}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload to show updated list
                        location.reload();
                    } else {
                        alert(data.message || 'Failed to delete R-SCM');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }
        
        // Edit R-SCM - Fixed version
        function editRSCM(rackName) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('edit-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'edit-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            
            // Set modal content
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Edit R-SCM</h3>
                    <form id="edit-rscm-form">
                        <input type="hidden" id="original-rack-name" name="original_rack_name">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-rack-name">Rack Name:</label>
                                <input type="text" id="edit-rack-name" name="rack_name" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-ip-address">IP Address:</label>
                                <input type="text" id="edit-ip-address" name="ip_address" required>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="primary-button">Update R-SCM</button>
                            <button type="button" class="secondary-button close-btn">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            console.log("Getting RSCM details for:", rackName);
            
            // Get RSCM details - using encodeURIComponent to handle spaces and special characters
            fetch(`/api/rscm/${encodeURIComponent(rackName)}`)
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("API response:", data);
                if (data.success) {
                    const rscm = data.rscm;
                    
                    // Store the original rack name to identify which rack to update
                    document.getElementById('original-rack-name').value = rackName;
                    
                    // Fill the form with data
                    document.getElementById('edit-rack-name').value = rscm.name;
                    document.getElementById('edit-ip-address').value = rscm.address;
                    
                    // Show the modal
                    modal.style.display = 'block';
                    
                    // Setup form submission
                    document.getElementById('edit-rscm-form').addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const formData = new FormData(this);
                        
                        fetch('/api/rscm/update', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Close modal
                                modal.style.display = 'none';
                                
                                // Reload the page to show changes
                                location.reload();
                            } else {
                                alert('Error updating R-SCM: ' + (data.message || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error updating R-SCM. Please check console for details.');
                        });
                    }, { once: true }); // Add once:true to prevent multiple event handlers
                    
                    // Close modal when clicking the X or Cancel button
                    document.querySelector('.close-modal').addEventListener('click', function() {
                        modal.style.display = 'none';
                    });
                    
                    document.querySelector('.close-btn').addEventListener('click', function() {
                        modal.style.display = 'none';
                    });
                } else {
                    alert('Error fetching R-SCM details: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching R-SCM details. Please check console for details.');
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (modal && event.target == modal) {
                modal.style.display = 'none';
            }
        };
        
        // Variables for the saved data viewer
        let powerChart = null;
        let currentData = null;
        
        // Function to load a file
        function loadFile(filename) {
            fetch(`/api/saved-data/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store the data for export
                        currentData = data;
                        
                        // Show the data viewer
                        document.getElementById('data-viewer').style.display = 'block';
                        document.getElementById('viewer-title').textContent = `Data Viewer: ${filename}`;
                        
                        // Scroll to the viewer
                        document.getElementById('data-viewer').scrollIntoView({ behavior: 'smooth' });
                        
                        // Update the stats
                        document.getElementById('stat-min').textContent = `${data.stats.min.toFixed(2)} W`;
                        document.getElementById('stat-max').textContent = `${data.stats.max.toFixed(2)} W`;
                        document.getElementById('stat-avg').textContent = `${data.stats.avg.toFixed(2)} W`;
                        document.getElementById('stat-mode').textContent = `${data.stats.mode.toFixed(2)} W`;
                        document.getElementById('stat-count').textContent = data.stats.count;
                        
                        // Create or update the chart
                        createChart(data.timestamps, data.power);
                    } else {
                        alert(`Error loading file: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading file. See console for details.');
                });
        }
        
        // Function to create or update the chart
        function createChart(timestamps, powerValues) {
            const ctx = document.getElementById('power-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (powerChart) {
                powerChart.destroy();
            }
            
            // Create new chart
            powerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Power (W)',
                        data: powerValues,
                        borderColor: 'rgb(33, 150, 243)',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Power (W)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
        }
        
        // Export functions
        document.getElementById('export-csv').addEventListener('click', function() {
            if (!currentData) return;
            
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,Timestamp,Power(W)\n";
            
            for (let i = 0; i < currentData.timestamps.length; i++) {
                csvContent += `${currentData.timestamps[i]},${currentData.power[i]}\n`;
            }
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `export_${currentData.filename}`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        });
        
        document.getElementById('export-png').addEventListener('click', function() {
            if (!powerChart) return;
            
            // Get the canvas as an image
            const canvas = document.getElementById('power-chart');
            const image = canvas.toDataURL("image/png");
            
            // Create download link
            const link = document.createElement("a");
            link.setAttribute("href", image);
            link.setAttribute("download", `chart_${currentData.filename.replace('.csv', '.png')}`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        });
        
        document.getElementById('hide-viewer').addEventListener('click', function() {
            document.getElementById('data-viewer').style.display = 'none';
        });
        
        // Pagination for Saved Data tab
        document.addEventListener('DOMContentLoaded', function() {
            let currentPage = 1;
            const itemsPerPage = 3; // Show 3 rack sections per page
            
            // Initialize pagination (now globally accessible)
            initPagination = function() {
                let initPagination;
                const rackSections = document.querySelectorAll('#rack-sections-container .rack-section');
                if (rackSections.length === 0) return;
                
                // Make all rack sections visible before pagination
                rackSections.forEach(section => {
                    section.style.removeProperty('display');
                });
                
                // Calculate total pages
                const totalPages = Math.ceil(rackSections.length / itemsPerPage);
                document.getElementById('total-pages').textContent = totalPages;
                
                // Assign pages to rack sections
                rackSections.forEach((section, index) => {
                    const page = Math.floor(index / itemsPerPage) + 1;
                    section.setAttribute('data-page', page);
                });
                
                // Reset the selected filter
                document.getElementById('rscm-selector').value = 'all';
                
                // Show only the first page initially
                showPage(1);
                
                // Enable/disable pagination buttons
                updatePaginationButtons(1, totalPages);
            };

            
            // Show a specific page
            function showPage(pageNum) {
                const rackSections = document.querySelectorAll('#rack-sections-container .rack-section');
                
                rackSections.forEach(section => {
                    if (section.getAttribute('data-page') == pageNum) {
                        section.style.display = "block";
                    } else {
                        section.style.display = "none";
                    }
                });
                
                // Update current page indicator
                document.getElementById('current-page').textContent = pageNum;
                currentPage = pageNum;
            }
            
            // Update pagination button states
            function updatePaginationButtons(current, total) {
                const prevButton = document.getElementById('prev-page');
                const nextButton = document.getElementById('next-page');
                
                prevButton.disabled = current <= 1;
                nextButton.disabled = current >= total;
            }
            
            // Previous page button
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    showPage(currentPage - 1);
                    updatePaginationButtons(currentPage, parseInt(document.getElementById('total-pages').textContent));
                }
            });
            
            // Next page button
            document.getElementById('next-page').addEventListener('click', function() {
                const totalPages = parseInt(document.getElementById('total-pages').textContent);
                if (currentPage < totalPages) {
                    showPage(currentPage + 1);
                    updatePaginationButtons(currentPage, totalPages);
                }
            });
            
            // Initialize pagination when the saved data tab becomes visible
            const savedDataTabButton = document.querySelector('.tablinks[data-tab="SavedDataTab"]');
            if (savedDataTabButton) {
                savedDataTabButton.addEventListener('click', function() {
                    // Wait a moment for the tab to become visible
                    setTimeout(initPagination, 50);
                });
            }
            
            // Also initialize pagination if the saved data tab is the active tab on load
            if (localStorage.getItem('activeTab') === 'SavedDataTab') {
                setTimeout(initPagination, 100);
            }
        });
        
    function filterRackSections(rackName) {
        const rackSections = document.querySelectorAll('#rack-sections-container .rack-section');
        const paginationControls = document.querySelector('.pagination-controls');
        
        // If showing all, restore pagination and show first page
        if (rackName === 'all') {
            paginationControls.style.display = 'flex';
            initPagination(); // Re-initialize pagination
            return;
        }
        
        // Hide pagination when filtering by a specific RSCM
        paginationControls.style.display = 'none';
        
        // Show only the selected RSCM's section
        rackSections.forEach(section => {
            const sectionTitle = section.querySelector('h3').textContent;
            if (sectionTitle === rackName) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
    }
    function openStartMonitoringModal(rackName) {
        const modal = document.getElementById('monitoring-modal');
        document.getElementById('rack-name-input').value = rackName;
        document.getElementById('monitor-status').textContent = '';
        document.getElementById('monitor-status').className = 'status-message';
        
        // Reset form to defaults
        document.getElementById('interval-input').value = '1.0';
        document.getElementById('duration-input').value = '0';
        
        modal.style.display = 'block';
    }
    
    function closeMonitoringModal() {
        document.getElementById('monitoring-modal').style.display = 'none';
    }
    
    // Handle monitoring form submission
    document.getElementById('start-monitoring-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const rackName = document.getElementById('rack-name-input').value;
        const interval = document.getElementById('interval-input').value;
        const duration = document.getElementById('duration-input').value;
        const statusElement = document.getElementById('monitor-status');
        
        const formData = new FormData();
        formData.append('rack_name', rackName);
        formData.append('interval', interval);
        formData.append('duration', duration);
        
        // Show loading message
        statusElement.textContent = 'Starting monitoring...';
        statusElement.className = 'status-message';
        
        fetch('/api/rscm/start-monitoring', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusElement.textContent = data.message;
                statusElement.className = 'status-message success';
                
                // Close the modal and refresh the page after a delay
                setTimeout(() => {
                    closeMonitoringModal();
                    location.reload();
                }, 1500);
            } else {
                statusElement.textContent = data.message;
                statusElement.className = 'status-message error';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            statusElement.textContent = 'An error occurred while starting monitoring';
            statusElement.className = 'status-message error';
        });
    });
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('monitoring-modal');
        if (event.target === modal) {
            closeMonitoringModal();
        }
    });
    
function stopMonitoring(rackName) {
    if (confirm(`Are you sure you want to stop monitoring ${rackName}?`)) {
        console.log(`Stopping monitoring for ${rackName}...`);
        
        fetch(`/api/rscm/pause/${rackName}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            console.log("Stop monitoring response:", data);
            
            if (data.success) {
                // Use the saved file from the response if available
                const fileName = data.saved_file || `${rackName}_data.csv`;
                
                // Show the notification
                showSaveNotification({
                    rackName: rackName,
                    fileName: fileName,
                    message: `Monitoring stopped for ${rackName}. Data has been saved.`,
                    success: true
                });
            } else {
                alert(data.message || 'Failed to stop monitoring');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error stopping monitoring:', error);
            alert('An error occurred while stopping monitoring');
            location.reload();
        });
    }
}
/*
function stopMonitoring(rackName) {
    if (confirm(`Are you sure you want to stop monitoring ${rackName}?`)) {
        console.log(`Stopping monitoring for ${rackName}...`);
        
        fetch(`/api/rscm/pause/${rackName}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            console.log("Received response:", data);
            
            if (data.success) {
                // Check if a file was saved
                if (data.saved_file) {
                    console.log(`File saved: ${data.saved_file}`);
                    // Show a simple notification
                    showSaveNotification({
                        rackName: rackName,
                        fileName: data.saved_file,
                        message: `Monitoring stopped for ${rackName}. Data saved to:`,
                        success: true
                    });
                } else {
                    console.log("No saved file in response");
                    // Show simple alert if no file was saved
                    alert(`Monitoring stopped for ${rackName}`);
                    // Reload to update UI
                    location.reload();
                }
            } else {
                alert(data.message || 'Failed to stop monitoring');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}
*/

function testShowNotification(rackName, fileName) {
    console.log("Testing notification display with:", {rackName, fileName});
    
    try {
        showSaveNotification({
            rackName: rackName,
            fileName: fileName,
            message: `Monitoring stopped for ${rackName}. Data saved to:`,
            success: true
        });
        console.log("Notification should be displayed now");
    } catch (error) {
        console.error("Error showing notification:", error);
        alert(`Monitoring stopped for ${rackName}. Error showing notification.`);
        location.reload();
    }
}

// Define the notification functions globally
function showSaveNotification(data) {
    console.log("showSaveNotification called with:", data);
    
    // Create notification overlay
    const overlay = document.createElement('div');
    overlay.className = 'notification-overlay';
    
    // Create notification content
    const notification = document.createElement('div');
    notification.className = 'save-notification';
    
    console.log("Building notification HTML");
    
    // Format the filename for better display
    const displayFileName = data.fileName || `Data for ${data.rackName}`;
    
    // Build notification content
    notification.innerHTML = `
        <div class="notification-header">
            <h3>Monitoring Complete</h3>
            <button class="close-notification" onclick="closeNotification()">&times;</button>
        </div>
        <div class="notification-content">
            <p>${data.message}</p>
            <div class="file-info">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                    <path d="M4.5 12.5A.5.5 0 0 1 5 12h3a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0-2A.5.5 0 0 1 5 10h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5z"/>
                </svg>
                <span class="file-name">${displayFileName}</span>
            </div>
        </div>
        <div class="notification-actions">
            <button class="action-btn view" onclick="viewSavedFile('${data.fileName}')">
                View Data
            </button>
            <button class="action-btn continue" onclick="closeNotification()">
                Continue
            </button>
        </div>
    `;
    
    console.log("Adding notification to overlay");
    // Add to document
    overlay.appendChild(notification);
    document.body.appendChild(overlay);
    
    console.log("Setting timeout for animation");
    // Add animation class after a small delay (for transition effect)
    setTimeout(() => {
        console.log("Adding visible class to notification");
        notification.classList.add('visible');
    }, 10);

    console.log("Notification setup complete");
}


function closeNotification() {
    console.log("closeNotification called");
    const overlay = document.querySelector('.notification-overlay');
    if (overlay) {
        console.log("Found overlay, starting fade-out");
        const notification = overlay.querySelector('.save-notification');
        notification.classList.remove('visible');
        
        setTimeout(() => {
            console.log("Removing overlay from DOM");
            document.body.removeChild(overlay);
            console.log("Reloading page");
            location.reload();
        }, 300);
    } else {
        console.log("No notification overlay found");
        location.reload();
    }
}

function viewSavedFile(fileName) {
    console.log(`Navigating to Saved Data tab for file: ${fileName}`);
    
    // Extract rack name from filename based on session ID format
    let rackName = fileName;
    if (fileName && fileName.includes('_')) {
        rackName = fileName.split('_')[0];
    }
    
    // Close the notification
    closeNotification();
    
    // Switch to the SavedDataTab
    const savedDataTab = document.querySelector('.tablinks[data-tab="SavedDataTab"]');
    if (savedDataTab) {
        console.log("Switching to Saved Data tab");
        const event = new MouseEvent('click', {
            bubbles: true,
            cancelable: true,
            view: window
        });
        savedDataTab.dispatchEvent(event);
        
        // Let the tab initialize
        setTimeout(() => {
            // Filter by rack name
            const rscmSelector = document.getElementById('rscm-selector');
            if (rscmSelector) {
                // Find options that match the rack name
                for (let i = 0; i < rscmSelector.options.length; i++) {
                    const option = rscmSelector.options[i];
                    if (option.value === rackName || option.value.includes(rackName) || rackName.includes(option.value)) {
                        console.log(`Filtering by RSCM: ${option.value}`);
                        rscmSelector.value = option.value;
                        filterRackSections(option.value);
                        break;
                    }
                }
            }
            
            // Try to find and load the file by its name
            setTimeout(() => {
                const fileCards = document.querySelectorAll('.file-card');
                let found = false;
                
                // Try to find an exact match first
                for (let card of fileCards) {
                    const cardTitle = card.querySelector('h4').textContent;
                    if (cardTitle === fileName) {
                        console.log(`Found exact file: ${cardTitle}`);
                        card.click();
                        found = true;
                        break;
                    }
                }
                
                // If no exact match, try to find the newest file for this rack
                if (!found && fileCards.length > 0) {
                    console.log(`No exact match found, looking for recent files for ${rackName}`);
                    // Find all files for this rack
                    const rackFiles = Array.from(fileCards).filter(card => {
                        const cardTitle = card.querySelector('h4').textContent;
                        return cardTitle.startsWith(rackName + '_');
                    });
                    
                    // If we found any files, click the first one (should be most recent)
                    if (rackFiles.length > 0) {
                        console.log(`Found ${rackFiles.length} files for ${rackName}, selecting first one`);
                        rackFiles[0].click();
                    }
                }
            }, 300);
        }, 300);
    } else {
        alert("Could not navigate to the Saved Data tab. Please go there manually to view your saved data.");
    }
}
    </script>
</body>
</html>